#/bin/sh

args=("$@")

case ${args[0]} in
PELAGOS)
    echo 'Setting Encore PublicPath to PELAGOS'
    export publicpath="--publicpath /pelagos-symfony/build"
    ;;
NAS)
    echo 'Setting Encore PublicPath to NAS'
    export publicpath="--publicpath /build"
    ;;
*)
    echo 'Please specify a Build Environment!'
    echo 'Options: [PELAGOS, NAS]'
    exit;
    ;;
esac

# Stop RabbitMQ consumers
bin/console rabbitmq-supervisor:control stop --wait-for-supervisord

# Run composer install to make sure all non-dev dependencies are installed and parameters are defined
composer install --no-dev --optimize-autoloader

# Handle Yarn
yarn install
yarn run encore prod $publicpath

# Dump ENV into compiled format
composer dump-env prod

# Warn of any pending migrations, but don't apply them.
bin/console doctrine:migrations:status

# cp supervisor config into var
cp config/supervisor/supervisord.conf var/supervisor/prod

# Rebuild Supervisor config for RabbitMQ consumers and start them
bin/console rabbitmq-supervisor:rebuild --wait-for-supervisord
bin/console messenger:stop-workers

# Rebuild elasticsearch indexes
bin/console fos:elastica:reset
bin/console fos:elastica:populate
