#/bin/sh

# Set Symfony environment to drupal_prod
export SYMFONY_ENV=drupal_prod

# Disable Symfony debug mode
export SYMFONY_DEBUG=0

# Stop RabbitMQ consumers
bin/console rabbitmq-supervisor:control stop --wait-for-supervisord

# Run composer install to make sure all non-dev dependencies are installed and parameters are defined
composer install --no-dev --optimize-autoloader

# Dump FOSJsRouting routes
echo "Dumping FOSJsRouting routes..."
bin/console fos:js-routing:dump --target=web/js/routing

# Handle Yarn
yarn install
yarn run encore prod

# Rebuild Supervisor config for RabbitMQ consumers and start them
bin/console rabbitmq-supervisor:rebuild --wait-for-supervisord
